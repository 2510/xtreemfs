<!DOCTYPE html>
<!-- 
Copyright (c) 2013 Matthias Noack, Zuse Institute Berlin 

Licensed under the BSD License, see LICENSE file for details.
-->
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=utf-8">

    <title>Server Status</title>

    <script type="text/javascript" src="d3.v3.js"></script>

    <style type="text/css">
    </style>

    <script type="text/javascript">
        
// configuration
var conf = new Object();
conf.hGrid = 125;
conf.canvasFrame = 25;
conf.reloadInterval = 2000; // in ms

conf.fileStatusRadius = 30;
conf.fileStatusSpace  = 10;
conf.fileStatusTextSize = 15;
conf.fileStatusTextSpace = 5;
conf.fileStatusTextColor = "#000";
conf.fileStatusBackgroundColor = "#eee";
conf.fileStatusCircleStyle = {
  "_default": {"stroke": "#000", "stroke-width": 1},
  "primary": {"fill": "#009900" },
  "backup": {"fill": "#000099"},
  "offline": {"fill": "#990000"},
  "unknown": {"fill": "#ddd"},
}

conf.hostStatusRadius = 40;
conf.hostStatusCircleStyle = {
  "_default": {"stroke": "#000", "stroke-width": 1},
  "online": {"fill": "#009900"},
  "offline": {"fill": "#990000"},
  "unknown": {"fill": "#ddd"}
}


// globals
var paused = false;
var intervalID = 0; // for periodic data fetch via GET


// helper functions
function hGridCenter(d, i) { return i * conf.hGrid + conf.hGrid / 2  }
function fileStatusHeight() { return conf.fileStatusRadius * 2 + conf.fileStatusSpace * 2 + conf.fileStatusTextSize + conf.fileStatusTextSpace }
function totalHeight(fileCount) { return fileCount * fileStatusHeight() + conf.hostStatusRadius * 3 }
function circleStyle(conf, attr) { return function(d) { return attr in conf[d] ? conf[d][attr] : conf["_default"][attr] } }


// init code
window.onload = function() {

	// insert svg as canvas
  d3.select("#container")
    .append("svg")
      .attr("id", "frame")
    .append("svg:g")
      .attr("id", "canvas")
      .attr("transform", "translate(" + conf.canvasFrame + " " + conf.canvasFrame + ")");

  var controls = d3.select("#controls");
  controls.append("button")
    .attr("id", "reloadButton")
    .text("Reload")
    .on("click", loadData);
  
  controls.append("button")
    .attr("id", "pauseButton")
    .text("Disable Auto Reload")
    .on("click", function() {
      if (paused) {
        paused = false;
        intervalID =  window.setInterval(loadData, conf.reloadInterval);
        d3.select(this).text("Disable Auto Reload");
      }
      else {
        paused = true;
        window.clearInterval(intervalID);
        d3.select(this).text("Enable Auto Reload");
      }
    });

  loadData();
  intervalID =  window.setInterval(loadData, conf.reloadInterval);
}

function loadData() {
  d3.json("/status", function(error, status) {
    if (error == null)
      draw(status);
    
    else {
      // TODO: show error
      console.log(error);
    }
  });
}

function draw(status) {
  var hostStatus = status["status"];
  var files = d3.entries(status["files"]).sort(function(x,y) { return x.key < y.key ? -1 : 1 });

  var totalWidth = hostStatus.length * conf.hGrid;

  var svg = d3.select("#frame")
    .attr("width", totalWidth + conf.canvasFrame * 2)
    .attr("height", totalHeight(files.length) + conf.canvasFrame * 2)

  var canvas = d3.select("#canvas");
    // .attr("viewBox", "0 0 " + totalWidth +  " " + totalHeight(files.length))
    // .attr("width", totalWidth)
    // .attr("height", totalHeight(files.length));

  var host_circles = canvas.selectAll("circle.host").data(hostStatus);
  host_circles.enter().append("svg:circle")
    .classed("host", true)
    .attr("r", conf.hostStatusRadius)
    .attr("cx", hGridCenter)
    .attr("cy", conf.hostStatusRadius)
    .attr("fill", circleStyle(conf.hostStatusCircleStyle, "fill"))
    .attr("stroke", circleStyle(conf.hostStatusCircleStyle, "stroke"))
    .attr("stroke-width", circleStyle(conf.hostStatusCircleStyle, "stroke-width"));
  
 host_circles.transition()
    .duration(1000)
    .attr("fill", circleStyle(conf.hostStatusCircleStyle, "fill"))
    .attr("stroke", circleStyle(conf.hostStatusCircleStyle, "stroke"))
    .attr("stroke-width", circleStyle(conf.hostStatusCircleStyle, "stroke-width"));
  
  var groups = canvas.selectAll("g").data(files, function(d) { return d.key });

  var groups_enter = groups.enter().append("svg:g")
    .attr("id", function(d) { return "file-" + d.key })
    .attr("transform", function(d, i) { return "translate(0 " + totalHeight(i) + ")" })
    .attr("font-size", conf.fileStatusTextSize)
    .attr("height", fileStatusHeight())
    .attr("width", totalWidth)
    .attr("opacity", 0)
    .attr("pointer-events", "all");
    
  groups.exit()
    .remove();

  groups_enter.append("svg:rect")
    .classed("background", true)
    .attr("height", fileStatusHeight())
    .attr("width", totalWidth)
    .attr("fill", "none")
    .attr("rx", 10);

  
  groups_enter.append("svg:text")
    .classed("file-id", true)
    .text(function(d, i) { return d.key })
    .attr("y", conf.fileStatusTextSize + conf.fileStatusTextSpace + conf.fileStatusSpace + conf.fileStatusRadius * 2)
    .attr("x", hGridCenter(null, 0) - conf.fileStatusRadius )
    .attr("fill", "none");

  
  groups.transition()
    .attr("transform", function(d, i) { return "translate(0 " + totalHeight(i) + ")" })
    .transition()
    .attr("opacity", 1);

  // TODO: optimize mouseover/out handling. they are fired multiple times because the event bubbles
  groups_enter
    .attr("pointer-events", "all")
    .on("mouseover", function() {
        d3.select(this).select("text.file-id").attr("fill", conf.fileStatusTextColor);
        d3.select(this).select("rect.background").attr("fill", conf.fileStatusBackgroundColor); })
    .on("mouseout", function() { d3.select(this).selectAll("text.file-id, rect.background").attr("fill", "none")  } )

  var circles = groups.selectAll("circle").data(function(d,i) { return d.value });

  circles.enter().append("svg:circle")
    .attr("r", conf.fileStatusRadius)
    .attr("cx", hGridCenter )
    .attr("cy", conf.fileStatusRadius + conf.fileStatusSpace )
    .attr("fill", circleStyle(conf.fileStatusCircleStyle, "fill"))
    .attr("stroke", circleStyle(conf.fileStatusCircleStyle, "stroke"))
    .attr("stroke-width", circleStyle(conf.fileStatusCircleStyle, "stroke-width"));

  circles.transition()
    .duration(1000)
    .attr("fill",  circleStyle(conf.fileStatusCircleStyle, "fill"))
    .attr("stroke", circleStyle(conf.fileStatusCircleStyle, "stroke"))
    .attr("stroke-width", circleStyle(conf.fileStatusCircleStyle, "stroke-width"));

  circles.exit()
         .remove();
}

// function random() {
// 
//   var s = { "status": d3.shuffle(["online", "online", "offline", "unknown"]).slice(0,3), "files": {} };
//   var states = ["primary", "backup", "backup", "unknown"];
// 
//   var files = {};
//   for (var i = 0; i < 10; i++) {
//     files["file-" + i] = d3.shuffle(states).slice(0,3);
//   }
//   s.files["file-0"] = files["file-" + 0];
// 
//   var n = Math.round(Math.random() * 5);
//   files = d3.shuffle(d3.entries(files));
//   for (var i = 0; i < n; i++) {
//     s["files"][files[i].key] = files[i].value;
//   }
// 
//   return s;
// }

    </script>
  </head>

  <body>
		<h1><a href="http://www.XtreemFS.org"><img src="http://www.xtreemfs.com/imgs/Logo_200px.jpg" alt="XtreemFS Logo"/></a> Server Status</h1>

    <div id="controls"></div>
		<div id="container"></div>
  </body>
</html>
